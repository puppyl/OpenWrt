name: å¤šä»“åº“è‡ªåŠ¨æ›´æ–°ç›‘æ§
env:
  # ğŸŸ¢ å®šä¹‰ç›‘æ§çš„ä»“åº“åˆ—è¡¨ï¼ˆJSON æ ¼å¼ï¼‰
  # æ¯ä¸ªä»“åº“éœ€è¦é…ç½®ï¼š
  # - name: ä»“åº“æ ‡è¯†ï¼ˆç®€çŸ­è‹±æ–‡ï¼‰
  # - url: ä»“åº“Gitåœ°å€
  # - branch: ç›‘æ§çš„åˆ†æ”¯
  # - event_type: è§¦å‘æ„å»ºçš„å”¯ä¸€äº‹ä»¶ç±»å‹
  REPOSITORIES: |
    [
      {
        "name": "lede",
        "url": "https://github.com/coolsnowwolf/lede",
        "branch": "master",
        "event_type": "lede-source-updated"
      },
      {
        "name": "immortalwrt",
        "url": "https://github.com/immortalwrt/immortalwrt",
        "branch": "main",
        "event_type": "immortalwrt-source-updated"
      }
    ]

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # ğŸŸ¢ å®šæ—¶è§¦å‘é…ç½®ï¼ˆUTCæ—¶é—´ï¼‰
    # âš ï¸ æ³¨æ„ï¼šæ‰€æœ‰ä»“åº“å…±äº«åŒä¸€ä¸ªæ£€æŸ¥é¢‘ç‡
    # - cron: "0 */6 * * *"  # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡

jobs:
  check_updates:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šå°†ç¯å¢ƒå˜é‡ä¸­çš„JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºè¾“å‡ºå˜é‡
      - name: è§£æä»“åº“é…ç½®
        id: repos
        run: |
          echo "repos_json=$REPOSITORIES" >> $GITHUB_OUTPUT
          # ğŸŸ¢ $REPOSITORIES æ˜¯envä¸­å®šä¹‰çš„JSONå­—ç¬¦ä¸²
          # ğŸ”„ è¾“å‡ºåˆ° steps.repos.outputs.repos_json

      # æ­¥éª¤2ï¼šå¾ªç¯å¤„ç†æ¯ä¸ªä»“åº“
      - name: éå†æ£€æŸ¥æ¯ä¸ªä»“åº“
        uses: nick-invision/foreach@v2  # GitHub Actionå®˜æ–¹æ¨èçš„å¾ªç¯å·¥å…·
        with:
          items: ${{ fromJson(steps.repos.outputs.repos_json) }}  # è§£æJSON
          format: '{name}|{url}|{branch}|{event_type}'  # å®šä¹‰æ•°æ®åˆ†å‰²æ ¼å¼
          run: |
            # ğŸŸ¢ åˆ†å‰²è¾“å…¥å‚æ•°
            REPO_NAME=$(echo "${{ item }}" | cut -d'|' -f1)
            REPO_URL=$(echo "${{ item }}" | cut -d'|' -f2)
            REPO_BRANCH=$(echo "${{ item }}" | cut -d'|' -f3)
            EVENT_TYPE=$(echo "${{ item }}" | cut -d'|' -f4)

            echo "ğŸ” å¼€å§‹æ£€æŸ¥ä»“åº“: $REPO_NAME ($REPO_BRANCH)"
            
            # æ“ä½œ1ï¼šå…‹éš†ä»“åº“ï¼ˆä»…æœ€æ–°commitï¼‰
            git clone --depth 1 $REPO_URL -b $REPO_BRANCH $REPO_NAME
            cd $REPO_NAME
            
            # æ“ä½œ2ï¼šè·å–æœ€æ–°Commit Hash
            CURRENT_HASH=$(git rev-parse HEAD)
            echo "æœ€æ–°Commit Hash: $CURRENT_HASH"
            
            # ğŸŸ¢ æ£€æŸ¥Hashæ˜¯å¦å˜åŒ–ï¼ˆä½¿ç”¨actions/cacheæœºåˆ¶ï¼‰
            CACHE_KEY="${REPO_NAME}-${REPO_BRANCH}-hash"  # âš ï¸ æ¯ä¸ªä»“åº“ç”¨ä¸åŒç¼“å­˜key
            PREV_HASH=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/caches" \
              | jq -r ".actions_caches[] | select(.key == \"$CACHE_KEY\") | .version" || echo "")
            
            if [[ "$PREV_HASH" != "$CURRENT_HASH" ]]; then
              echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼æ—§Hash: ${PREV_HASH:-æ— è®°å½•}, æ–°Hash: $CURRENT_HASH"
              
              # æ“ä½œ3ï¼šä¿å­˜æ–°Hashåˆ°ç¼“å­˜ï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰
              curl -X POST \
                -H "Authorization: Bearer ${{ github.token }}" \
                -H "Accept: application/vnd.github.everest-preview+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/caches" \
                -d '{"key":"'"$CACHE_KEY"'", "version":"'"$CURRENT_HASH"'"}'
              
              # æ“ä½œ4ï¼šè§¦å‘æ„å»ºäº‹ä»¶
              echo "ğŸš€ è§¦å‘æ„å»ºäº‹ä»¶: $EVENT_TYPE"
              curl -X POST \
                -H "Authorization: Bearer ${{ github.token }}" \
                -H "Accept: application/vnd.github.everest-preview+json" \
                "https://api.github.com/repos/${{ github.repository }}/dispatches" \
                -d '{"event_type":"'"$EVENT_TYPE"'", "client_payload":{"repo":"'"$REPO_NAME"'", "branch":"'"$REPO_BRANCH"'"}}'
            else
              echo "âœ… æ— æ›´æ–°ï¼Œè·³è¿‡è§¦å‘"
            fi

      # æ­¥éª¤3ï¼šæ¸…ç†æ—§å·¥ä½œæµè®°å½•ï¼ˆä¿ç•™æœ€è¿‘2æ¬¡ï¼‰
      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0    # ä¿ç•™0å¤©å‰çš„è®°å½•
          keep_minimum_runs: 2  # è‡³å°‘ä¿ç•™2æ¬¡è¿è¡Œè®°å½•
