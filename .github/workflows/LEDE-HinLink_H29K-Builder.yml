name: LEDE-HinLink_H29K-Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds_config/LEDE/HinLink_H29K/feeds.conf.default
  CONFIG_FILE: config/LEDE/HinLink_H29K/.config
  DIY_P1_SH: DIY_Script/LEDE/HinLink_H29K/diy-part1.sh
  DIY_P2_SH: DIY_Script/LEDE/HinLink_H29K/diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: \033[1;32mâœ… ä»“åº“æ ¡éªŒ\033[0m
        uses: actions/checkout@v4
        shell: bash
        run: |
          printf "\033[1;32mğŸ” æ ¡éªŒä»“åº“å®Œæ•´æ€§...\033[0m\n"
          git status

      - name: \033[1;32mâœ¨ åˆå§‹åŒ–ç¯å¢ƒ\033[0m
        shell: bash
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          printf "\033[1;35mâš™ï¸ å¼€å§‹æ¸…ç†å’Œå®‰è£…ä¾èµ–...\033[0m\n"
          sudo rm -rf /etc/apt/sources.list.d/* \
            /usr/share/dotnet \
            /usr/local/lib/android \
            /opt/ghc \
            /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          sudo apt-get -qq update
          sudo apt-get -qq install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
            libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
            libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
            pkgconf python2.7 python3 python3-pyelftools qemu-utils rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget \
            xmlto xxd zlib1g-dev
          sudo apt-get autoremove -qq --purge
          sudo apt-get clean -qq
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir
          printf "\033[1;32mâœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼\033[0m\n"

      - name: \033[1;32mğŸ“Š ç¡¬ä»¶é…ç½®æ£€æµ‹\033[0m
        shell: bash
        run: |
          printf "\033[1;31mâš ï¸ è­¦å‘Šï¼šæœåŠ¡å™¨æ€§èƒ½ç›´æ¥å½±å“ç¼–è¯‘é€Ÿåº¦ï¼Œå»ºè®®é€‰æ‹©é«˜æ€§èƒ½å®ä¾‹ï¼\033[0m\n"
          printf "\033[1;36mâ–¬â–¬â–¬â–¬â–¬ CPU ä¿¡æ¯ â–¬â–¬â–¬â–¬â–¬\033[0m\n"
          printf "å‹å·: \033[1;33m$(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)\033[0m\n"
          printf "æ ¸å¿ƒæ•°: \033[1;33m$(nproc) çº¿ç¨‹\033[0m\n"
          printf "\033[1;36mâ–¬â–¬â–¬â–¬â–¬ å†…å­˜ä¿¡æ¯ â–¬â–¬â–¬â–¬â–¬\033[0m\n"
          printf "æ€»å†…å­˜: \033[1;33m$(free -h | awk '/Mem:/ {print $2}')\033[0m\n"
          printf "\033[1;36mâ–¬â–¬â–¬â–¬â–¬ ç£ç›˜ä¿¡æ¯ â–¬â–¬â–¬â–¬â–¬\033[0m\n"
          df -Th | sed 's/^/\t/' | sed "s/ / \033[1;33m/g"

      - name: \033[1;32mğŸ“¥ å…‹éš†æºç \033[0m
        working-directory: /workdir
        shell: bash
        run: |
          printf "\033[1;35mğŸ”— å…‹éš† LEDE ä¸»ä»“åº“ï¼ˆåˆ†æ”¯: $REPO_BRANCHï¼‰...\033[0m\n"
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH lede
          ln -sf /workdir/lede $GITHUB_WORKSPACE/lede
          printf "\033[1;32mâœ… æºç å…‹éš†æˆåŠŸï¼è·¯å¾„: /workdir/lede\033[0m\n"

      - name: \033[1;32mâš¡ åŠ è½½è®¢é˜…æº\033[0m
        shell: bash
        run: |
          printf "\033[1;35mğŸ”§ åŠ è½½è‡ªå®šä¹‰ feeds.conf æ–‡ä»¶...\033[0m\n"
          [ -f "$FEEDS_CONF" ] && cp -v "$FEEDS_CONF" lede/feeds.conf.default
          [ -d "files/LEDE/HinLink_H29K" ] && cp -Rvf files/LEDE/HinLink_H29K/* lede/
          printf "\033[1;35mğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ $DIY_P1_SH\033[0m\n"
          chmod +x "$DIY_P1_SH"
          cd lede && "$GITHUB_WORKSPACE/$DIY_P1_SH"
          printf "\033[1;32mâœ… è®¢é˜…æºé…ç½®å®Œæˆï¼\033[0m\n"

      - name: \033[1;32mğŸ”„ æ›´æ–°è®¢é˜…æº\033[0m
        shell: bash
        run: |
          printf "\033[1;35mğŸ” æ›´æ–° feeds...\033[0m\n"
          cd lede && ./scripts/feeds update -a
          [ $? -eq 0 ] && printf "\033[1;32mâœ… æ›´æ–°æˆåŠŸï¼\033[0m\n" || exit 1

      - name: \033[1;32mğŸ“¦ å®‰è£…è®¢é˜…æº\033[0m
        shell: bash
        run: |
          printf "\033[1;35mğŸ“¥ å®‰è£… feeds...\033[0m\n"
          cd lede && ./scripts/feeds install -a
          [ $? -eq 0 ] && printf "\033[1;32mâœ… å®‰è£…å®Œæˆï¼\033[0m\n" || exit 1

      - name: \033[1;32mğŸ”§ åŠ è½½å›ºä»¶é…ç½®\033[0m
        shell: bash
        run: |
          printf "\033[1;35mâš™ï¸ å¯¼å…¥é¢„ç½®é…ç½®æ–‡ä»¶ .config ...\033[0m\n"
          [ -f "$CONFIG_FILE" ] && cp -v "$CONFIG_FILE" lede/.config
          printf "\033[1;35mğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ $DIY_P2_SH\033[0m\n"
          chmod +x "$DIY_P2_SH"
          cd lede && "$GITHUB_WORKSPACE/$DIY_P2_SH"
          printf "\033[1;32mâœ… é…ç½®åŠ è½½æˆåŠŸï¼\033[0m\n"

      - name: \033[1;32mğŸ“¦ ä¸‹è½½è½¯ä»¶åŒ…\033[0m
        id: download-packages
        shell: bash
        run: |
          printf "\033[1;35mâ¬ ä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…...\033[0m\n"
          cd lede
          make defconfig
          make download -j$(($(nproc) * 2)) || make download -j1
          find dl -size -1k -delete
          printf "\033[1;32mâœ… ä¸‹è½½å®Œæˆï¼\033[0m\n"

      - name: \033[1;32mğŸ”¨ ç¼–è¯‘å›ºä»¶\033[0m
        id: compile-firmware
        shell: bash
        run: |
          printf "\033[1;35mğŸ”¥ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨ $\033[1;33m$(nproc)\033[1;35m çº¿ç¨‹ï¼‰...\033[0m\n"
          cd lede
          make -j$(nproc) || { 
            printf "\033[1;31mâš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘...\033[0m\n" && make -j1 V=s; 
          }
          echo "status=success" >> $GITHUB_OUTPUT
          DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "DEVICE_NAME=_${DEVICE_NAME}" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV
          printf "\033[1;32mğŸ‰ å›ºä»¶ç¼–è¯‘å®Œæˆï¼\033[0m\n"

      - name: \033[1;32mğŸ“¤ ä¸Šä¼ å›ºä»¶\033[0m
        if: ${{ success() && env.UPLOAD_FIRMWARE == 'true' }}
        uses: actions/upload-artifact@v4
        shell: bash
        with:
          name: OpenWrt-Firmware-${{ env.DEVICE_NAME }}-${{ env.FILE_DATE }}
          path: |
            lede/bin/targets/**/*
            !lede/bin/targets/**/packages
            !lede/bin/targets/**/*.buildinfo
            !lede/bin/targets/**/*.manifest

      - name: \033[1;32mğŸ·ï¸ åˆ›å»º Releases\033[0m
        if: ${{ success() && env.UPLOAD_RELEASE == 'true' }}
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: LEDE-H29K-${{ env.FILE_DATE }}
          files: lede/bin/targets/**/*.bin

      - name: \033[1;32mğŸ§¹ æ¸…ç†æ—§æ•°æ®\033[0m
        shell: bash
        run: |
          printf "\033[1;35mğŸ§½ æ¸…ç†è¶…è¿‡ 7 å¤©çš„æ—§å·¥ä½œæµ...\033[0m\n"
          gh run list --workflow=$GITHUB_WORKFLOW --json databaseId -q '.[].databaseId' --limit 100 --jq '.[]' \
            | xargs -I {} bash -c "if (( {} < $(date -d '-7 days' +%s) )); then gh run delete {}; fi"
