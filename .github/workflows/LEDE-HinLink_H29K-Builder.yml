name: OpenWRT AutoBuild

on:
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 0 * * *" # æ¯æ—¥UTCæ—¶é—´0ç‚¹è‡ªåŠ¨æ„å»º

env:                    # å…¨å±€ç¯å¢ƒå˜é‡
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: files/feeds.conf
  CONFIG_FILE: files/HinLink_H29K.config
  DIY_P1_SH: files/script/diy-part1.sh
  DIY_P2_SH: files/script/diy-part2.sh

jobs:
  build:                # ä¸»æ„å»ºä»»åŠ¡
    runs-on: ubuntu-22.04
    timeout-minutes: 180 # 3å°æ—¶è¶…æ—¶
    
    steps:              # æ­¥éª¤å¼€å§‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    # â–ˆâ–ˆâ–ˆ åˆå§‹åŒ–é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: æ ¡éªŒä»“åº“
      uses: actions/checkout@v4   # å®˜æ–¹checkout action
      
    - name: åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        echo -e "\n\033[1;35mâ•”â•â•â•â•â•â•â•â• å¼€å§‹ç¯å¢ƒåˆå§‹åŒ– [$(date +%H:%M)] â•â•â•â•â•â•â•â•â•—\033[0m"
        echo -e "\033[1;36mâ–· è®¾ç½®æ—¶åŒºä¸º $TZ å¹¶åˆ›å»ºå·¥ä½œç›®å½•...\033[0m"
        sudo timedatectl set-timezone "$TZ"              # è®¾ç½®æ—¶åŒº
        sudo mkdir -p /workdir                           # åˆ›å»ºæŒä¹…åŒ–ç›®å½•
        sudo chown $USER:$GROUPS /workdir                # ä¿®æ­£ç›®å½•æƒé™
        echo -e "\033[1;32mâœ“ ç¯å¢ƒå°±ç»ª â—€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
        echo -e "\033[1;35mâ•šâ•â•â•â•â•â•â•â• ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ [è€—æ—¶: $SECONDSç§’] â•â•â•â•â•â•â•â•â•\033[0m\n"
      env:
        DEBIAN_FRONTEND: noninteractive

    # â–ˆâ–ˆâ–ˆ ç¡¬ä»¶æ£€æŸ¥é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo -e "\n\033[1;41mâ—ï¸ è­¦å‘Š â—ï¸\033[0m"
        echo -e "\033[1;33mâ–¼ äº‘è®¡ç®—èµ„æºæœ‰é™ï¼Œå»ºè®®æ§åˆ¶æ’ä»¶æ•°é‡ä»¥é˜²è¶…è½½ â–¼\033[0m"
        echo -e "\033[1;35mâ•â–¶ æ£€æŸ¥æ—¶é—´: $(date +%Y-%m-%d\ %H:%M:%S) â—€â•\033[0m"
        
        # CPUä¿¡æ¯å±•ç¤º
        echo -e "\n\033[1;36mâ–Œâ”â”â”â”â”â”â”â”â”â” CPUè¯¦æƒ… â”â”â”â”â”â”â”â”â”â”â–Œ\033[0m"
        lscpu | grep -E "Model name|Socket|Thread|MHz" | sed 's/^/  â–/'
        
        # å†…å­˜ä¿¡æ¯å±•ç¤º
        echo -e "\n\033[1;36mâ–Œâ”â”â”â”â”â”â”â”â” å†…å­˜ä¿¡æ¯ â”â”â”â”â”â”â”â”â”â”â–Œ\033[0m"
        free -h | awk '{printf "  â–%-15s %s\n", $1, $2}' | tail -n +2
        
        # å­˜å‚¨ç©ºé—´å±•ç¤º
        echo -e "\n\033[1;36mâ–Œâ”â”â”â”â”â”â”â”â” å­˜å‚¨ç©ºé—´ â”â”â”â”â”â”â”â”â”â”â–Œ\033[0m"
        df -hT / | awk 'NR==2 {printf "  â–å¯ç”¨: %s/%s (%s)\n", $4,$3,$6}'
        echo -e "\033[1;35mâ•â–¶ ç³»ç»Ÿæ£€æŸ¥å®Œæ¯• [è€—æ—¶: $SECONDSç§’] â—€â•\033[0m\n"

    # â–ˆâ–ˆâ–ˆ æºç è·å–é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: è·å– OpenWRT æºç 
      working-directory: /workdir  # æŒ‡å®šå·¥ä½œç›®å½•
      run: |
        echo -e "\n\033[1;33mâ¬‡ï¸  å¼€å§‹å…‹éš†ä»“åº“ ($REPO_BRANCH åˆ†æ”¯)...\033[0m"
        git clone $REPO_URL -b $REPO_BRANCH lede --depth=1 2>&1 | sed 's/^/  â¤ /'
        
        # åˆ›å»ºè½¯é“¾æ–¹ä¾¿åç»­æ“ä½œ
        ln -sf /workdir/lede $GITHUB_WORKSPACE/lede
        echo -e "\033[1;32mâœ“ æºç è·å–å®Œæˆ! (å¤§å°: $(du -sh lede | cut -f1))\033[0m\n"

    # â–ˆâ–ˆâ–ˆ è‡ªå®šä¹‰é…ç½®é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
      run: |
        echo -e "\n\033[1;35mâš™ï¸  å¼€å§‹æ³¨å…¥è‡ªå®šä¹‰é…ç½®\033[0m"
        
        # æ‹·è´è®¾å¤‡é…ç½®æ–‡ä»¶
        if [ -e files ]; then
          echo -e "  ğŸ›  åº”ç”¨ HinLink é…ç½®..." ; sounds/Fans/fan3
          cp -rf files/LEDE/HinLink_H29K/* lede/
        fi
        
        # æ›´æ–° feeds é…ç½®
        [ -e "$FEEDS_CONF" ] && {
          echo -e "  ğŸ”„ æ›¿æ¢ feeds é…ç½®" ; sounds/Cartoon/jump
          mv $FEEDS_CONF lede/feeds.conf.default
        }
        
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        echo -e "  ğŸ“œ æ‰§è¡Œ DIY è„šæœ¬" ; sounds/Interface/menu1
        chmod +x $DIY_P1_SH
        cd lede && $GITHUB_WORKSPACE/$DIY_P1_SH
        echo -e "\033[1;32mâœ“ é…ç½®åº”ç”¨æˆåŠŸ â—€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m\n"

    # â–ˆâ–ˆâ–ˆ ä¾èµ–ç®¡ç†é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: æ›´æ–°è½¯ä»¶æº
      run: |
        echo -e "\n\033[1;34mğŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶æº (æ­¤æ­¥éª¤å¯èƒ½éœ€è¦3-5åˆ†é’Ÿ)...\033[0m"
        cd lede
        ./scripts/feeds update -a | while read line; do
          echo -e "  â–¹ ${line}"
        done
        echo -e "\033[1;32mâœ“ æºæ›´æ–°å®Œæˆï¼Œå…±æ›´æ–° $(./scripts/feeds list -r | wc -l) ä¸ªåŒ…\033[0m\n"

    - name: å®‰è£…ä¾èµ–åŒ…
      run: |
        echo -e "\n\033[1;34mğŸ“¦ æ­£åœ¨å®‰è£…åŸºç¡€è½¯ä»¶åŒ…...\033[0m"
        cd lede
        ./scripts/feeds install -a | awk '{printf "  â–¸ %s\n", $0}'
        echo -e "\033[1;32mâœ“ å·²å®‰è£… $(ls package/ | wc -w) ä¸ªè½¯ä»¶åŒ…\033[0m\n"

    # â–ˆâ–ˆâ–ˆ ç¼–è¯‘å‡†å¤‡é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: åº”ç”¨è®¾å¤‡é…ç½®
      run: |
        echo -e "\n\033[1;33mğŸ”§ æ­£åœ¨é…ç½®è®¾å¤‡å‚æ•°...\033[0m"
        [ -e "$CONFIG_FILE" ] && {
          cp "$CONFIG_FILE" lede/.config
          echo -e "  âœ… ä½¿ç”¨é¢„è®¾é…ç½®æ–‡ä»¶"
        }
        
        # æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        chmod +x "$DIY_P2_SH"
        cd lede
        "$GITHUB_WORKSPACE/$DIY_P2_SH" | sed 's/^/  âœ /'
        echo -e "\033[1;32mâœ“ è®¾å¤‡é…ç½®å®Œæˆ â—€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m\n"

    - name: ä¸‹è½½ç¼–è¯‘èµ„æº
      run: |
        echo -e "\n\033[1;36mâ³ å¼€å§‹ä¸‹è½½ä¾èµ–æ–‡ä»¶ (é¢„è®¡éœ€è¦5-15åˆ†é’Ÿ)...\033[0m"
        cd lede
        make defconfig
        time make download -j$(($(nproc)*2)) | tee download.log  # å¹¶è¡Œä¸‹è½½
        
        # å¤„ç†ä¸‹è½½å¤±è´¥çš„å°æ–‡ä»¶
        echo -e "\n\033[1;33mğŸ” æ£€æŸ¥æ— æ•ˆä¸‹è½½...\033[0m"
        awk '/size mismatch/{print $2}' download.log | xargs -I{} rm -f {}
        echo -e "\033[1;32mâœ“ èµ„æºå‡†å¤‡å®Œæ¯• (ä¸‹è½½ç›®å½•å¤§å°: $(du -sh dl | cut -f1))\033[0m\n"

    # â–ˆâ–ˆâ–ˆ ç¼–è¯‘é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: æ‰§è¡Œå›ºä»¶ç¼–è¯‘
      timeout-minutes: 120
      run: |
        echo -e "\n\033[1;41mğŸ”¥ é‡è¦ç¼–è¯‘é˜¶æ®µå¼€å§‹ â” $(date +%H:%M:%S) â”â”â”â”â”â”â”â”\033[0m"
        echo -e "  ğŸ’» ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
        echo -e "  â³ é¢„è®¡è€—æ—¶: 30â€¯~â€¯90 åˆ†é’Ÿ"
        echo -e "\033[1;31mâ— æ­¤é˜¶æ®µå‡ºç°é”™è¯¯éœ€è¦äººå·¥ä»‹å…¥æ£€æŸ¥\033[0m"
        
        cd lede
        SECONDS=0  # è®¡æ—¶å¼€å§‹
        make -j$(nproc) V=s 2>&1 | tee build.log
        
        # ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        echo -e "\n\033[1;35mğŸ“Š ç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯:\033[0m"
        echo -e "  âŒ› æ€»è€—æ—¶: $((SECONDS / 60))åˆ†$((SECONDS % 60))ç§’"
        grep -oP 'warning:.*' build.log | sort | uniq -c | sort -nr | head -5 | sed 's/^/  âš ï¸  /'
        echo -e "\033[1;42mğŸ‰ å›ºä»¶ç¼–è¯‘æˆåŠŸï¼\033[0m\n"

    # â–ˆâ–ˆâ–ˆ åæœŸå¤„ç†é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: å¤„ç†ç”Ÿæˆæ–‡ä»¶
      if: success()
      run: |
        echo -e "\n\033[1;35mğŸ“¦ æ‰“åŒ…ç¼–è¯‘äº§ç‰©...\033[0m"
        cd lede/bin/targets/*/*
        mkdir -p artifact
        mv *.bin *.manifest artifact/ || true
        
        echo -e "\033[1;36mğŸ”„ ç”Ÿæˆchecksumæ ¡éªŒæ–‡ä»¶...\033[0m"
        sha256sum artifact/* > checksums.txt
        echo -e "\033[1;32mâœ“ ç”Ÿæˆæ–‡ä»¶å¤§å°: $(du -sh artifact)\033[0m\n"

    - name: æ¸…ç†ç¼–è¯‘ç¼“å­˜
      if: always()
      run: |
        echo -e "\n\033[1;33mğŸ§¹ æ‰§è¡Œæ¸…ç†æ“ä½œ...\033[0m"
        cd lede
        make clean
        sudo rm -rf /workdir/lede/build_dir /workdir/lede/staging_dir
        echo -e "  ğŸ—‘ å·²é‡Šæ”¾ $(df -h / | awk 'NR==2 {print $4}') å¯ç”¨ç©ºé—´"

    # â–ˆâ–ˆâ–ˆ ç»“æœä¸Šä¼ é˜¶æ®µ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v3
      with:
        name: OpenWRT-Build-$(date +%Y%m%d)
        path: lede/bin/targets/*/*/artifact/
        retention-days: 7
