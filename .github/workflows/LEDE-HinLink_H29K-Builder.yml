name: LEDE-HinLink_H29K-Builder  # âœ… å·¥ä½œæµæ˜¾ç¤ºåç§°åœ¨æ­¤å¤„å®šä¹‰

on:
  # â–¼â–¼â–¼ ä¿æŒåŸæœ‰è§¦å‘æ¡ä»¶ â–¼â–¼â–¼
  repository_dispatch: {}
  workflow_dispatch: {}

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds_config/LEDE/HinLink_H29K/feeds.conf.default
  CONFIG_FILE: config/LEDE/HinLink_H29K/.config
  DIY_P1_SH: DIY_Script/LEDE/HinLink_H29K/diy-part1.sh
  DIY_P2_SH: DIY_Script/LEDE/HinLink_H29K/diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # â–¼â–¼â–¼ æ­¥éª¤åç§°å»é™¤äº† ANSI è½¬ä¹‰ â–¼â–¼â–¼
      - name: "âœ… 1/10 ä»“åº“æ ¡éªŒ"
        uses: actions/checkout@v4
        shell: bash
        run: |
          printf "\033[1;32m[æ ¡éªŒ] æ­£åœ¨æ£€æŸ¥ä»“åº“çŠ¶æ€...\033[0m\n"
          git status

      - name: "âœ¨ 2/10 åˆå§‹åŒ–ç¯å¢ƒ"
        shell: bash
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          printf "\033[1;35m[ç¯å¢ƒ] å®‰è£…ä¾èµ– (è¯¦ç»†æ—¥å¿—æ¨¡å¼)\033[0m\n"
          # â–¼â–¼â–¼ ä¿æŒåŸå§‹æ¸…ç†å’Œå®‰è£…å‘½ä»¤ â–¼â–¼â–¼
          sudo rm -rf /etc/apt/sources.list.d/* \
            /usr/share/dotnet \
            /usr/local/lib/android \
            /opt/ghc \
            /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          sudo apt-get -qq update
          sudo apt-get -qq install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
            libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
            libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
            pkgconf python2.7 python3 python3-pyelftools qemu-utils rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget \
            xmlto xxd zlib1g-dev
          printf "\033[1;32m[ç¯å¢ƒ] ä¾èµ–å®‰è£…å®Œæˆï¼å½“å‰æ—¶é—´: $(date)\033[0m\n"

      - name: "ğŸ“Š 3/10 ç¡¬ä»¶æ£€æµ‹"
        shell: bash
        run: |
          # â–¼â–¼â–¼ ä¿ç•™åŸå§‹é¢œè‰²è¾“å‡ºä½†ä»…ä½œç”¨äºæ—¥å¿— â–¼â–¼â–¼
          printf "\033[1;31m[è­¦å‘Š] é«˜æ€§èƒ½æœåŠ¡å™¨å¯æå‡ç¼–è¯‘é€Ÿåº¦ï¼\033[0m\n"
          printf "\033[1;36mâ–¬â–¬ CPU â–¬â–¶ \033[0m$(lscpu | grep 'Model name' | cut -d':' -f2)\n"
          printf "\033[1;36mâ–¬â–¬ å†…å­˜ â–¬â–¶ \033[0m$(free -h | awk '/Mem:/ {print $2}')\n"

      - name: "ğŸ“¥ 4/10 å…‹éš†æºç "
        working-directory: /workdir
        shell: bash
        run: |
          printf "\033[1;35m[æºç ] å…‹éš†ä»“åº“åˆ° /workdir/lede ...\033[0m\n"
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH lede
          ln -sf /workdir/lede $GITHUB_WORKSPACE/lede

      # â–¼â–¼â–¼ åç»­æ­¥éª¤ä¿æŒç›¸åŒä¿®å¤æ¨¡å¼ â–¼â–¼â–¼
      - name: "âš¡ 5/10 åŠ è½½è®¢é˜…æº"
        shell: bash
        run: |
          printf "\033[1;35m[è®¢é˜…] åŠ è½½ feeds.conf é…ç½®æ–‡ä»¶\033[0m\n"
          [ -f "$FEEDS_CONF" ] && cp -v "$FEEDS_CONF" lede/feeds.conf.default
          chmod +x "$DIY_P1_SH"
          cd lede && "$GITHUB_WORKSPACE/$DIY_P1_SH"

      - name: "ğŸ”„ 6/10 æ›´æ–°è®¢é˜…æº"
        shell: bash
        run: |
          printf "\033[1;35m[è®¢é˜…] æ›´æ–° feeds...\033[0m\n"
          cd lede && ./scripts/feeds update -a

      - name: "ğŸ“¦ 7/10 å®‰è£…è®¢é˜…æº"
        shell: bash
        run: |
          printf "\033[1;35m[è®¢é˜…] å®‰è£… feeds è½¯ä»¶åŒ…\033[0m\n"
          cd lede && ./scripts/feeds install -a

      - name: "ğŸ”§ 8/10 åŠ è½½é…ç½®"
        shell: bash
        run: |
          printf "\033[1;35m[é…ç½®] åº”ç”¨é¢„è®¾æ–‡ä»¶ $CONFIG_FILE\033[0m\n"
          [ -f "$CONFIG_FILE" ] && cp -v "$CONFIG_FILE" lede/.config
          chmod +x "$DIY_P2_SH"
          cd lede && "$GITHUB_WORKSPACE/$DIY_P2_SH"

      - name: "ğŸ”¨ 9/10 ç¼–è¯‘å›ºä»¶"
        shell: bash
        run: |
          printf "\033[1;35m[ç¼–è¯‘] å¯åŠ¨å¤šçº¿ç¨‹ç¼–è¯‘ (CPU æ ¸å¿ƒæ•°: $(nproc))\033[0m\n"
          cd lede
          make -j$(nproc) || { 
            printf "\033[1;31m[é”™è¯¯] å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å•çº¿ç¨‹æ¨¡å¼ï¼\033[0m\n"
            make -j1 V=s
          }

      - name: "ğŸš€ 10/10 ä¸Šä¼ å›ºä»¶"
        if: ${{ success() && env.UPLOAD_FIRMWARE == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: H29K-Bin-$(date +'%Y%m%d')
          path: lede/bin/targets/**/*.bin
