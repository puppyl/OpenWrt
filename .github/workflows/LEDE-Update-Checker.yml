name: "æ™ºèƒ½æ›´æ–°"

env:
  ç›‘æ§ä»“åº“åœ°å€: https://github.com/coolsnowwolf/lede
  ç›‘æ§åˆ†æ”¯: master
  ç›®æ ‡å·¥ä½œæµåˆ—è¡¨: "LEDE-MangoPi_M28C-Builder"  # å¤šä¸ªå·¥ä½œæµç”¨é€—å·åˆ†éš”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # UTCæ—¶é—´20:00(åŒ—äº¬æ—¶é—´04:00)

jobs:
  æ›´æ–°æ£€æŸ¥:
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸš€ åˆå§‹åŒ–ç›‘æ§ç³»ç»Ÿ"
        run: |
          echo "#############################################"
          echo "#                                           #"
          echo "#       æ™ºèƒ½ä»“åº“ç›‘æ§ç³»ç»Ÿ å¯åŠ¨ä¸­...           #"
          echo "#  $(date +'%Y-%m-%d %H:%M:%S')               #"
          echo "#                                           #"
          echo "#############################################"

      - name: "ğŸ” è·å–æºç æœ€æ–°æŒ‡çº¹"
        id: è·å–å“ˆå¸Œ
        run: |
          echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
          echo "â–ˆ æ­£åœ¨å…‹éš†ä»“åº“å¹¶æå–æäº¤å“ˆå¸Œ..."
          git clone --depth 1 $ç›‘æ§ä»“åº“åœ°å€ -b $ç›‘æ§åˆ†æ”¯ .
          å½“å‰å“ˆå¸Œ=$(git rev-parse HEAD)
          echo "â–ˆ æœ€æ–°æäº¤å“ˆå¸Œ: ${å½“å‰å“ˆå¸Œ:0:7}...${å½“å‰å“ˆå¸Œ: -7}"
          echo "â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€"
          echo "commitHash=$å½“å‰å“ˆå¸Œ" >> $GITHUB_OUTPUT

      - name: "ğŸ“Š æ¯”å¯¹ä»“åº“å†å²è®°å½•"
        id: ç¼“å­˜æ¯”å¯¹
        uses: actions/cache@v3
        with:
          path: .commitHash
          key: commitHash_${{ steps.è·å–å“ˆå¸Œ.outputs.commitHash }}

      - name: "ğŸ’¾ ä¿å­˜æ–°æŒ‡çº¹æ•°æ®"
        if: steps.ç¼“å­˜æ¯”å¯¹.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ†• æ£€æµ‹åˆ°ä»“åº“æ›´æ–°ï¼æ­£åœ¨è®°å½•æ–°æŒ‡çº¹..."
          echo ${{ steps.è·å–å“ˆå¸Œ.outputs.commitHash }} | tee .commitHash
          echo "âœ… æŒ‡çº¹æ•°æ®å·²å­˜å…¥å®‰å…¨å­˜å‚¨åŒº"

      - name: "ğŸ”” è§¦å‘ååŒå·¥ä½œæµ"
        if: always()
        run: |
          echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ"
          echo "â–ˆ  è°ƒåº¦ä¸­å¿ƒæ¥åˆ°æŒ‡ä»¤ï¼Œæ­£åœ¨åˆ†å‘ä»»åŠ¡...         â–ˆ"
          echo "â–ˆ  ç›®æ ‡å·¥ä½œæµ: ${{ env.ç›®æ ‡å·¥ä½œæµåˆ—è¡¨ }}     â–ˆ"
          echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ"
          
          IFS=',' read -ra å·¥ä½œæµæ•°ç»„ <<< "$ç›®æ ‡å·¥ä½œæµåˆ—è¡¨"
          for å·¥ä½œæµ in "${å·¥ä½œæµæ•°ç»„[@]}"; do
            å·¥ä½œæµ=$(echo $å·¥ä½œæµ | xargs)  # å»é™¤å‰åç©ºæ ¼
            echo "âš¡ æ­£åœ¨è§¦å‘å·¥ä½œæµ: $å·¥ä½œæµ"
            curl -X POST \
              -H "Authorization: token ${{ github.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/$å·¥ä½œæµ/dispatches \
              -d '{"ref":"${{ github.ref }}","inputs":{"force_build":"${{ github.event_name == 'schedule' }}"}}'
            echo "âœ” å·²å‘é€è§¦å‘ä¿¡å·"
          done

      - name: "ğŸ§¹ æ¸…ç†ç³»ç»Ÿæ—¥å¿—"
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 3
