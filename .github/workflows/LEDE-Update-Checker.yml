name: "ğŸ›°ï¸ æ™ºèƒ½æºç ç›‘æ§ç³»ç»Ÿ"

env:
  ç›‘æ§ä»“åº“åœ°å€: https://github.com/coolsnowwolf/lede
  ç›‘æ§åˆ†æ”¯: master
  ç›®æ ‡å·¥ä½œæµåˆ—è¡¨: "LEDE-MangoPi_M28C-Builder.yml"  # æ”¹ä¸ºå®é™…çš„å·¥ä½œæµæ–‡ä»¶å

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # UTCæ—¶é—´20:00(åŒ—äº¬æ—¶é—´04:00)

jobs:
  ä»“åº“æ›´æ–°ç›‘æ§:
    name: "ğŸ›¡ï¸ [ä¸»æ§å•å…ƒ] ä»“åº“æ›´æ–°ç›‘æ§"
    runs-on: ubuntu-latest

    steps:
      # ----------------------- ç³»ç»Ÿåˆå§‹åŒ–ä¼ªè£… -----------------------
      - name: "ğŸš€ å¯åŠ¨ç³»ç»Ÿ"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                              â•‘"
          echo "â•‘        ä»“åº“ç›‘æ§ç³»ç»Ÿ åˆå§‹åŒ–ä¸­...              â•‘"
          echo "â•‘       $(date +'%Y-%m-%d %H:%M:%S')              â•‘"
          echo "â•‘                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â–· æ­£åœ¨åŠ è½½æ ¸å¿ƒæ¨¡å—..."
          sleep 0.5
          echo "âœ” è™šæ‹Ÿç¯å¢ƒå·²å°±ç»ª"
          sleep 0.3

      # ----------------------- å®é™…å·¥ä½œæµç¨‹ -----------------------
      - name: "ğŸ” æŒ‡çº¹æ‰«æ"
        id: scan
        run: |
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ æ­£åœ¨åˆ†æç›®æ ‡ä»“åº“ï¼š${{ env.ç›‘æ§ä»“åº“åœ°å€ }}    â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          git clone --depth 1 ${{ env.ç›‘æ§ä»“åº“åœ°å€ }} -b ${{ env.ç›‘æ§åˆ†æ”¯ }} .
          å½“å‰å“ˆå¸Œ=$(git rev-parse HEAD)
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ æœ€æ–°æäº¤å“ˆå¸Œ: ${å½“å‰å“ˆå¸Œ:0:7}...${å½“å‰å“ˆå¸Œ: -7} â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "commitHash=$å½“å‰å“ˆå¸Œ" >> $GITHUB_OUTPUT

      - name: "ğŸ“Š æŒ‡çº¹æ¯”å¯¹"
        id: cache_check
        uses: actions/cache@v3
        with:
          path: .commitHash
          key: commitHash_${{ steps.scan.outputs.commitHash }}

      - name: "ë…¼ ä¿å­˜æ–°æŒ‡çº¹æ•°æ®"
        if: steps.cache_check.outputs.cache-hit != 'true'
        run: |
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åˆ·æ–°æŒ‡çº¹æ•°æ®ä¸­...                             â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "${{ steps.scan.outputs.commitHash }}" | tee .commitHash
          echo "âœ… æŒ‡çº¹æ•°æ®å·²æ›´æ–°"

      - name: "ğŸ”” è§¦å‘ååŒå·¥ä½œæµ"
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  è°ƒåº¦ä¸­å¿ƒæ¥åˆ°æŒ‡ä»¤ï¼Œæ­£åœ¨åˆ†å‘ä»»åŠ¡...         â•‘"
          echo "â•‘  ç›®æ ‡å·¥ä½œæµ: ${{ env.ç›®æ ‡å·¥ä½œæµåˆ—è¡¨ }}     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          IFS=',' read -ra å·¥ä½œæµæ•°ç»„ <<< "${{ env.ç›®æ ‡å·¥ä½œæµåˆ—è¡¨ }}"
          for å·¥ä½œæµ in "${å·¥ä½œæµæ•°ç»„[@]}"; do
            å·¥ä½œæµ=$(echo $å·¥ä½œæµ | xargs)
            echo "âš¡ æ­£åœ¨è§¦å‘å·¥ä½œæµ: $å·¥ä½œæµ"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$å·¥ä½œæµ/dispatches" \
              -d '{"ref":"master","inputs":{"force_build":"${{ github.event_name == '\''schedule'\'' }}"}}'
            sleep 1  # é¿å…è§¦å‘é¢‘ç‡è¿‡é«˜
          done

      - name: "ğŸ§¹ æ¸…ç†æ—¥å¿—"
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 3
