name: ImmortalWrt-X86_64-Builder

on:
  # ä¸¤ç§è§¦å‘æ–¹å¼ï¼š
  # 1. repository_dispatch - å…è®¸é€šè¿‡APIæ‰‹åŠ¨è§¦å‘
  # 2. workflow_dispatch - å…è®¸åœ¨GitHubç½‘é¡µç•Œé¢ä¸Šæ‰‹åŠ¨è§¦å‘
  repository_dispatch:
  workflow_dispatch:

env:
  # æºç ä»“åº“é…ç½®
  REPO_URL: https://github.com/immortalwrt/immortalwrt  # ImmortalWrtå®˜æ–¹ä»“åº“åœ°å€
  REPO_BRANCH: master                                   # ä½¿ç”¨çš„ä»£ç åˆ†æ”¯
  
  # é…ç½®æ–‡ä»¶è·¯å¾„
  CONFIG_FILE: Config/ImmortalWrt/X86_64.config         # ä¸»é…ç½®æ–‡ä»¶è·¯å¾„
  Feeds_SH: Scripts/ImmortalWrt/X86_64/Feeds.sh         # è®¢é˜…æºè„šæœ¬è·¯å¾„
  Settings_SH: Scripts/ImmortalWrt/X86_64/Settings.sh   # è®¾ç½®è„šæœ¬è·¯å¾„
  Packages_SH: Scripts/ImmortalWrt/X86_64/Packages.sh   # è½¯ä»¶åŒ…è„šæœ¬è·¯å¾„
  
  # æ„å»ºè¾“å‡ºæ§åˆ¶
  UPLOAD_BIN_DIR: false     # æ˜¯å¦ä¸Šä¼ binç›®å½•(åŒ…å«æ„å»ºä¸­é—´æ–‡ä»¶)
  UPLOAD_FIRMWARE: true     # æ˜¯å¦ä¸Šä¼ æœ€ç»ˆå›ºä»¶
  UPLOAD_RELEASE: true      # æ˜¯å¦åˆ›å»ºGitHubå‘å¸ƒ
  
  TZ: Asia/Shanghai         # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´

jobs:
  build:
    runs-on: ubuntu-22.04   # ä½¿ç”¨Ubuntu 22.04ç³»ç»Ÿä½œä¸ºæ„å»ºç¯å¢ƒ

    steps:
    # === 1. å‡†å¤‡é˜¶æ®µ ===
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4
      # å¤‡æ³¨ï¼šè¿™ä¸€æ­¥ä½¿ç”¨å®˜æ–¹checkoutåŠ¨ä½œè·å–å½“å‰ä»“åº“ä»£ç 

    # === 2. ç³»ç»Ÿæ£€æŸ¥ ===
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "âš ï¸ æ€§èƒ½è­¦å‘Šï¼šæœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œè¿‡å¤šæ’ä»¶å¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥"
        echo "å·²çŸ¥CPUæ€§èƒ½é™åºï¼š7763 > 8370C > 8272CL > 8171M > E5-2673"
        
        # æ˜¾ç¤ºCPUä¿¡æ¯
        echo -e "\n=== CPUä¿¡æ¯ ==="
        echo "ç‰©ç†æ ¸å¿ƒæ•°: $(grep -c '^processor' /proc/cpuinfo)"
        echo "é€»è¾‘çº¿ç¨‹æ•°: $(nproc)"
        echo "CPUå‹å·: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^[ \t]*//')"
        
        # æ˜¾ç¤ºå†…å­˜ä¿¡æ¯
        echo -e "\n=== å†…å­˜ä¿¡æ¯ ===" 
        free -h
        
        # æ˜¾ç¤ºç£ç›˜ä¿¡æ¯
        echo -e "\n=== ç£ç›˜ä¿¡æ¯ ==="
        df -hT
        # å¤‡æ³¨ï¼šæ­¤æ­¥éª¤å¸®åŠ©è¯Šæ–­æ„å»ºç¯å¢ƒèµ„æºæƒ…å†µ
    # === 3. ç¯å¢ƒåˆå§‹åŒ– ===
    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo ">>> æ­£åœ¨æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
        sudo rm -rf /etc/apt/sources.list.d/* \
                   /usr/share/dotnet \
                   /usr/local/lib/android \
                   /opt/ghc \
                   /opt/hostedtoolcache/CodeQL
        
        echo ">>> æ­£åœ¨æ¸…ç†Dockeræ˜ åƒ..."
        sudo docker image prune -af
        
        echo ">>> æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…..."
        sudo apt-get -qq update
        
        echo ">>> æ­£åœ¨å®‰è£…ç¼–è¯‘ä¾èµ–..."
        curl -s https://build-scripts.lede-project.org/init_build_environment.sh | sudo -E bash -
        
        echo ">>> æ­£åœ¨æ‰§è¡Œæ¸…ç†..."
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean
        
        echo ">>> é…ç½®å·¥ä½œç¯å¢ƒ..."
        sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir
        sudo timedatectl set-timezone "$TZ"
      env:
        DEBIAN_FRONTEND: noninteractive  # é¿å…å®‰è£…è¿‡ç¨‹ä¸­çš„äº¤äº’æç¤º
        TZ: ${{ env.TZ }}                # å¤ç”¨å…¨å±€æ—¶åŒºè®¾ç½®
      # å¤‡æ³¨ï¼šUbuntuç¯å¢ƒä¸‹å®‰è£…OpenWrtç¼–è¯‘æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–

    # === 4. æºç è·å– ===
    - name: å…‹éš†ImmortalWrtæºç 
      working-directory: /workdir  # æŒ‡å®šå·¥ä½œç›®å½•
      run: |
        echo "å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT $PWD
        
        echo ">>> æ­£åœ¨å…‹éš†æºç ..."
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH ImmortalWrt
        
        echo ">>> åˆ›å»ºç¬¦å·é“¾æ¥..."
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
      # å¤‡æ³¨ï¼š--depth=1åªå…‹éš†æœ€æ–°æäº¤ï¼Œå‡å°‘ä¸‹è½½é‡

    # === 5. è‡ªå®šä¹‰é…ç½® ===
    - name: åŠ è½½è‡ªå®šä¹‰è®¢é˜…æº
      run: |
        # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶åˆ°æºç ç›®å½•
        if [ -d "Files/ImmortalWrt/X86_64" ]; then
          echo ">>> æ£€æµ‹åˆ°è‡ªå®šä¹‰æ–‡ä»¶ï¼Œæ­£åœ¨å¤åˆ¶..."
          cp -rf Files/ImmortalWrt/X86_64/* ImmortalWrt/
        else
          echo "!!! æœªæ‰¾åˆ°è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•"
        fi
        
        # æ‰§è¡Œè®¢é˜…æºè„šæœ¬
        if [ -f "$Feeds_SH" ]; then
          echo ">>> æ­£åœ¨æ‰§è¡Œè®¢é˜…æºè„šæœ¬..."
          chmod +x "$Feeds_SH"
          bash "$GITHUB_WORKSPACE/$Feeds_SH"
        else
          echo "!!! è®¢é˜…æºè„šæœ¬ä¸å­˜åœ¨ï¼š$Feeds_SH"
        fi
      # å¤‡æ³¨ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰è½¯ä»¶æºé“¾æ¥

    # === 6. æºç å‡†å¤‡ ===
    - name: æ›´æ–°è½¯ä»¶æº
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
      # å¤‡æ³¨ï¼šæ›´æ–°æ‰€æœ‰å¯ç”¨çš„è½¯ä»¶åŒ…æº

    - name: å®‰è£…è½¯ä»¶åŒ…
      run: |
        cd ImmortalWrt
        ./scripts/feeds install -a
      # å¤‡æ³¨ï¼šå®‰è£…æ‰€æœ‰å·²é…ç½®çš„è½¯ä»¶åŒ…

    # === 7. é…ç½®ç¼–è¯‘é€‰é¡¹ ===
    - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
      run: |
        # åº”ç”¨ä¸»é…ç½®æ–‡ä»¶
        if [ -f "$CONFIG_FILE" ]; then
          echo ">>> æ­£åœ¨åº”ç”¨ä¸»é…ç½®..."
          mv "$CONFIG_FILE" ImmortalWrt/.config
        else
          echo "!!! ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š$CONFIG_FILE"
        fi
        
        # åº”ç”¨è®¾ç½®è„šæœ¬
        if [ -f "$Settings_SH" ]; then
          echo ">>> æ­£åœ¨æ‰§è¡Œè®¾ç½®è„šæœ¬..."
          chmod +x "$Settings_SH"
          cd ImmortalWrt && bash "$GITHUB_WORKSPACE/$Settings_SH"
        else
          echo "!!! è®¾ç½®è„šæœ¬ä¸å­˜åœ¨ï¼š$Settings_SH"
        fi
      # å¤‡æ³¨ï¼šæ­¤æ­¥éª¤ä¼šå†³å®šæœ€ç»ˆå›ºä»¶åŒ…å«å“ªäº›åŠŸèƒ½å’Œé©±åŠ¨

    # === 8. ä¾èµ–ä¸‹è½½ ===
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd ImmortalWrt
        
        echo ">>> ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
        echo ">>> å¹¶è¡Œä¸‹è½½ä¾èµ–åŒ…(8çº¿ç¨‹)..."
        make download -j8 || {
          echo "!!! é¦–æ¬¡ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•å•çº¿ç¨‹ä¸‹è½½..."
          make download -j1
        }
        
        echo ">>> æ¸…ç†ä¸å®Œæ•´ä¸‹è½½..."
        find dl -size -1024c -delete
      # å¤‡æ³¨ï¼šæå‰ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…ï¼Œé¿å…ç¼–è¯‘è¿‡ç¨‹ä¸­æ–­

    # === 9. ç¼–è¯‘è¿‡ç¨‹ ===
    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ImmortalWrt
        
        echo ">>> å¼€å§‹ç¼–è¯‘(çº¿ç¨‹æ•°: $(nproc))..."
        make -j$(nproc) || {
          echo "!!! å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 || {
            echo "!!! å•çº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå¯ç”¨è¯¦ç»†æ¨¡å¼..."
            make -j1 V=s
          }
        }
        
        # è®°å½•ç¼–è¯‘çŠ¶æ€
        echo "status=success" >> $GITHUB_OUTPUT
        
        # æå–è®¾å¤‡åç§°
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | \
          sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
      # å¤‡æ³¨ï¼šé‡‡ç”¨ä¸‰çº§é™çº§ç¼–è¯‘ç­–ç•¥æé«˜æˆåŠŸç‡

    # === 10. ç©ºé—´æ£€æŸ¥ ===
    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())  # ä»…åœ¨æœªè¢«å–æ¶ˆæ—¶æ‰§è¡Œ
      run: |
        echo ">>> æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -hT
      # å¤‡æ³¨ï¼šå¸®åŠ©è¯Šæ–­æ˜¯å¦éœ€è¦å¢åŠ ç¼“å­˜ç©ºé—´

    # === 11. æ„å»ºäº§ç‰©å¤„ç† ===
    - name: ä¸Šä¼ binç›®å½•(å¯é€‰)
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ImmortalWrt/bin
        retention-days: 3  # è‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶
      # å¤‡æ³¨ï¼šä¸Šä¼ åŒ…å«æ‰€æœ‰ä¸­é—´æ–‡ä»¶çš„å®Œæ•´binç›®å½•

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        
        echo ">>> æ­£åœ¨æ¸…ç†éå¿…è¦æ–‡ä»¶..."
        rm -rf packages *.buildinfo *.json *.manifest
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
      # å¤‡æ³¨ï¼šç§»é™¤è°ƒè¯•æ–‡ä»¶ï¼Œå‡å°‘ä¸Šä¼ ä½“ç§¯

    - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: ImmortalWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}
        retention-days: 7
      # å¤‡æ³¨ï¼šä¸Šä¼ ç²¾ç®€åçš„å›ºä»¶æ–‡ä»¶

    # === 12. å‘å¸ƒç®¡ç† ===
    - name: å‡†å¤‡å‘å¸ƒè¯´æ˜
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        echo "release_tag=ImmortalWrt-X86_64-$(date +"%Y.%m.%d-%H%M%S")" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        cat <<EOF > release.txt
        ğŸš€ ImmortalWrt è‡ªåŠ¨æ„å»ºç»“æœ
        
        ğŸ“… ç¼–è¯‘æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S %Z")
        ğŸ’» è®¾å¤‡å‹å·: X86_64
        
        ğŸ”— æºç ä»“åº“: $REPO_URL
        ğŸŒ± ä»£ç åˆ†æ”¯: $REPO_BRANCH
        
        ğŸ” é»˜è®¤å‡­æ®:
          IP: 192.168.100.3
          ç”¨æˆ·å: root
          å¯†ç : password
        EOF
        
        echo "status=success" >> $GITHUB_OUTPUT
      # å¤‡æ³¨ï¼šç”Ÿæˆæ ¼å¼åŒ–çš„å‘å¸ƒè¯´æ˜

    - name: å‘å¸ƒå›ºä»¶
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # è‡ªåŠ¨ä½¿ç”¨GitHubä»¤ç‰Œ
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false
      # å¤‡æ³¨ï¼šåˆ›å»ºæ­£å¼çš„GitHubå‘å¸ƒ

    # === 13. æ¸…ç†ç­–ç•¥ ===
    - name: æ¸…ç†æ—§å·¥ä½œæµ
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0      # ç«‹å³æ¸…ç†å®Œæˆçš„å·¥ä½œæµ
        keep_minimum_runs: 2 # ä¿ç•™æœ€æ–°çš„2ä¸ªè®°å½•
      # å¤‡æ³¨ï¼šé˜²æ­¢å·¥ä½œæµè®°å½•å †ç§¯

    - name: æ¸…ç†æ—§å‘å¸ƒ
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10     # ä¿ç•™æœ€æ–°çš„10ä¸ªå‘å¸ƒ
        delete_tags: true   # åŒæ—¶åˆ é™¤å…³è”çš„æ ‡ç­¾
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # å¤‡æ³¨ï¼šè‡ªåŠ¨ç®¡ç†å‘å¸ƒç‰ˆæœ¬ï¼Œé¿å…å­˜å‚¨ç©ºé—´æµªè´¹